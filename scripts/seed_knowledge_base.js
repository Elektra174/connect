/**
 * CONNECTUM PRO v20.3 - KNOWLEDGE SEEDER (OPTIMIZED)
 * ========================================================
 * –î–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —è–≤–ª—è–µ—Ç—Å—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º "–ø–µ—Ä–≤–∏—á–Ω–æ–π –ø—Ä–æ—à–∏–≤–∫–∏" –ò–ò.
 * üöÄ –ó–∞–≥—Ä—É–∂–∞–µ—Ç 300+ —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –≤ Supabase (pgvector).
 * üß† –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–¥–µ–ª—å Google text-embedding-004 —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
 * üõ° –í–Ω–µ–¥—Ä–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ Exponential Backoff –¥–ª—è –æ–±—Ö–æ–¥–∞ –ª–∏–º–∏—Ç–æ–≤ Free Tier.
 * ‚ö° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏.
 */

require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');
const { GoogleGenerativeAI } = require("@google/generative-ai");
const winston = require('winston');
const NodeCache = require('node-cache');

// --- üõ°Ô∏è –õ–û–ì–ò–†–û–í–ê–ù–ò–ï (Winston) ---
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/seed.log' }),
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    })
  ],
});

// --- üß† –ö–≠–® –í–ï–ö–¢–û–†–û–í ---
const vectorCache = new NodeCache({ stdTTL: 3600, checkperiod: 600 });

// --- ‚öôÔ∏è –ü–†–û–í–ï–†–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø ---
const checkEnv = () => {
    const missing = [];
    if (!process.env.SUPABASE_URL) missing.push("SUPABASE_URL");
    if (!process.env.SUPABASE_KEY) missing.push("SUPABASE_KEY");
    if (!process.env.GOOGLE_API_KEYS) missing.push("GOOGLE_API_KEYS");

    if (missing.length > 0) {
        console.error("‚ùå –û—à–∏–±–∫–∞: –í —Ñ–∞–π–ª–µ .env –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:", missing.join(", "));
        process.exit(1);
    }
};

checkEnv();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –∫–ª—é—á–µ–π
const googleApiKeys = process.env.GOOGLE_API_KEYS.split(',');
let currentKeyIndex = 0;

const getCurrentGoogleKey = () => {
    return googleApiKeys[currentKeyIndex];
};

const rotateGoogleKey = () => {
    currentKeyIndex = (currentKeyIndex + 1) % googleApiKeys.length;
    console.log(`üîÑ Rotated to Google API key #${currentKeyIndex + 1}/${googleApiKeys.length}`);
};

const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_KEY);
const genAI = new GoogleGenerativeAI(getCurrentGoogleKey());

/**
 * üìö –†–ï–ï–°–¢–† –≠–¢–ê–õ–û–ù–ù–´–• –ó–ù–ê–ù–ò–ô (–Ø–¥—Ä–æ Connectum)
 */
const KNOWLEDGE_DATA = [
    // --- üíé –ú–ü–¢ (–ê–õ–ï–ö–°–ê–ù–î–† –í–û–õ–´–ù–°–ö–ò–ô) ---
    { mod: 'mpt', cat: '–ê–≤—Ç–æ—Ä—Å—Ç–≤–æ', trigger: '–ö–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç "–æ–Ω–æ —Å–∞–º–æ", "–º–µ–Ω—è –º—É—á–∞–µ—Ç"', text: '–ß—Ç–æ –¢–´ –¥–µ–ª–∞–µ—à—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, —á—Ç–æ–±—ã —ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–æ—Å—å? –ü–æ–∫–∞–∂–∏ —Ç–µ–ª–æ–º —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ.', marker: '–ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å—É–±—ä–µ–∫—Ç–Ω—É—é –ø–æ–∑–∏—Ü–∏—é' },
    { mod: 'mpt', cat: '–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å', trigger: '–°—Ç—Ä–∞—Ö –≤–Ω–µ—à–Ω–µ–π —Å–∏–ª—ã –∏–ª–∏ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–∞', text: '–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –∏ –µ—Å—Ç—å —ç—Ç–∞ —Å–∏–ª–∞. –ö–∞–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –±—ã—Ç–∏—è —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –∏–∑ —ç—Ç–æ–π —Ä–æ–ª–∏? –ü—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è?', marker: '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ —á–µ—Ä–µ–∑ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é' },
    { mod: 'mpt', cat: '–¢–æ—á–∫–∞ —Ä–µ—à–µ–Ω–∏—è', trigger: '–ö–ª–∏–µ–Ω—Ç –∑–∞—Å—Ç—Ä—è–ª –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –±–æ–ª–∏', text: '–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞. –û–ø–∏—à–∏ —Å–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ —ç—Ç–æ–π —Ç–æ—á–∫–∏ –±—É–¥—É—â–µ–≥–æ. –ö–∞–∫ –¥—ã—à–∏—Ç—Å—è?', marker: '–¢–µ–ª–µ—Å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, –≤–¥–æ—Ö' },
    { mod: 'mpt', cat: '–ü–æ–∑–∏—Ç–∏–≤–Ω–∞—è —Ü–µ–ª—å', trigger: '–°–∞–±–æ—Ç–∞–∂, –ª–µ–Ω—å, –æ—Ç–∫–ª–∞–¥—ã–≤–∞–Ω–∏–µ', text: '–û—Ç –∫–∞–∫–æ–π –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç–µ–±—è –±–µ—Ä–µ–∂–µ—Ç —ç—Ç–æ—Ç —Å–∞–±–æ—Ç–∞–∂? –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ –µ–≥–æ –∑–∞ –∑–∞—â–∏—Ç—É. –ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è?', marker: '–°–Ω—è—Ç–∏–µ –≤–∏–Ω—ã, –ª–µ–≥–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–¥—ã—Ö–∞' },
    { mod: 'mpt', cat: '–ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å', trigger: '–Ø –Ω–∏–∫—á–µ–º–Ω—ã–π / –Ø –¥–µ—Ñ–µ–∫—Ç–Ω—ã–π', text: '–ö—Ç–æ —ç—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç? –°—Ç–∞–Ω—å —ç—Ç–∏–º –∫—Ä–∏—Ç–∏–∫–æ–º. –ö–∞–∫—É—é —Å–≤–æ—é —Å–∏–ª—É —Ç—ã –≤–∫–ª–∞–¥—ã–≤–∞–µ—à—å –≤ —ç—Ç–æ –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ?', marker: '–ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ –∞–≥—Ä–µ—Å—Å–∏–∏' },

    // --- üß© –ö–ü–¢ (–ë–ï–ö) ---
    { mod: 'cbt', cat: '–î–∏—Å–ø—É—Ç', trigger: '–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏–∑–∞—Ü–∏—è (–í—Å–µ –ø—Ä–æ–ø–∞–ª–æ)', text: '–ö–∞–∫–æ–≤–∞ —Ä–µ–∞–ª—å–Ω–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—É–¥—à–µ–≥–æ –∏—Å—Ö–æ–¥–∞ –≤ —Ü–∏—Ñ—Ä–∞—Ö? –ö–∞–∫–∏–µ –µ—Å—Ç—å —Ñ–∞–∫—Ç—ã –ø—Ä–æ—Ç–∏–≤ —ç—Ç–æ–π –º—ã—Å–ª–∏?', marker: '–õ–æ–≥–∏—á–µ—Å–∫–∞—è –æ–ø–æ—Ä–∞' },
    { mod: 'cbt', cat: '–î–æ–ª–∂–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–µ', trigger: '–Ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–º', text: '–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç, –µ—Å–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å "–¥–æ–ª–∂–µ–Ω" –Ω–∞ "—Ö–æ—Ç–µ–ª –±—ã"? –°—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –ª–∏ —Ç—ã –æ—Ç —ç—Ç–æ–≥–æ —Ö—É–∂–µ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫?', marker: '–°–Ω—è—Ç–∏–µ –∑–∞–∂–∏–º–∞ –≤ –≥—Ä—É–¥–∏' },
    { mod: 'cbt', cat: '–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç', trigger: '–°—Ç—Ä–∞—Ö –æ—Ü–µ–Ω–∫–∏ –æ–∫—Ä—É–∂–∞—é—â–∏—Ö', text: '–î–∞–≤–∞–π –ø—Ä–æ–≤–µ–¥–µ–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç: —Å–æ–≤–µ—Ä—à–∏ –º–∞–ª–µ–Ω—å–∫—É—é –æ—à–∏–±–∫—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ. –ß—Ç–æ —Ç—ã –∑–∞–º–µ—Ç–∏—à—å –≤ —Ä–µ–∞–∫—Ü–∏–∏ –ª—é–¥–µ–π?', marker: '–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –Ω–æ–≤–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é' },

    // --- üåä –ì–ï–®–¢–ê–õ–¨–¢ (–ü–ï–†–õ–ó) ---
    { mod: 'gestalt', cat: '–ö–æ–Ω—Ç–∞–∫—Ç', trigger: '–†–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è (–£—Ö–æ–¥ –≤ –≥–æ–ª–æ–≤—É)', text: '–Ø –≤–∏–∂—É, –∫–∞–∫ —Ç—ã —Å–µ–π—á–∞—Å –∑–∞–¥–µ—Ä–∂–∞–ª –¥—ã—Ö–∞–Ω–∏–µ. –ß—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –∫–æ –º–Ω–µ –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç?', marker: '–í–æ–∑–≤—Ä–∞—Ç –≤ "–ó–¥–µ—Å—å –∏ –°–µ–π—á–∞—Å"' },
    { mod: 'gestalt', cat: '–ü–æ–ª—è—Ä–Ω–æ—Å—Ç–∏', trigger: '–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç —á–∞—Å—Ç–µ–π', text: '–ü–æ—Å–∞–¥–∏ —Å–≤–æ—é "–ª–µ–Ω–∏–≤—É—é —á–∞—Å—Ç—å" –Ω–∞ –ø—É—Å—Ç–æ–π —Å—Ç—É–ª. –û —á–µ–º –æ–Ω–∞ —Ö–æ—á–µ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç—å —Ç–≤–æ—é "–¥–µ—è—Ç–µ–ª—å–Ω—É—é —á–∞—Å—Ç—å"?', marker: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞' },

    // --- üé® –≠–û–¢ (–õ–ò–ù–î–ï) ---
    { mod: 'eit', cat: '–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è', trigger: '–¢—è–∂–µ—Å—Ç—å –∫–∞–∫ –æ–±—Ä–∞–∑ –∫–∞–º–Ω—è/—É–∑–ª–∞', text: '–°—Ç–∞–Ω—å —ç—Ç–∏–º –∫–∞–º–Ω–µ–º. –ß–µ–≥–æ —Ç—ã —Ö–æ—á–µ—à—å –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Ö–æ–¥–∏—à—å—Å—è? –î–∞–π –æ–±—Ä–∞–∑—É —Ä–µ—Å—É—Ä—Å.', marker: '–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞/–≤–µ—Å–∞ –æ–±—Ä–∞–∑–∞' },
    { mod: 'eit', cat: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', trigger: '–î—ã—Ä–∞ –≤ —Å–µ—Ä–¥—Ü–µ (–ø–æ—Ç–µ—Ä—è –ª—é–±–≤–∏)', text: '–í–µ—Ä–Ω–∏ —Å–µ–±–µ —Ç—É –ª—é–±–æ–≤—å, –∫–æ—Ç–æ—Ä—É—é —Ç—ã –æ—Ç–¥–∞–ª —ç—Ç–æ–º—É —á–µ–ª–æ–≤–µ–∫—É. –í–¥–æ—Ö–Ω–∏ –µ—ë –∫–∞–∫ –∑–æ–ª–æ—Ç–æ–π —Å–≤–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ.', marker: '–û—â—É—â–µ–Ω–∏–µ –Ω–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏' },

    // --- üé≠ –¢–ê (–ë–ï–†–ù) ---
    { mod: 'ta', cat: '–≠–≥–æ-—Å–æ—Å—Ç–æ—è–Ω–∏—è', trigger: '–ñ–∞–ª–æ–±–∞ –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ –ñ–µ—Ä—Ç–≤—ã', text: '–ü–æ—Ö–æ–∂–µ, —Å–µ–π—á–∞—Å –≥–æ–≤–æ—Ä–∏—Ç —Ç–≤–æ–π –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –†–µ–±–µ–Ω–æ–∫. –ß—Ç–æ –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É –¥—É–º–∞–µ—Ç —Ç–≤–æ–π –í–∑—Ä–æ—Å–ª—ã–π?', marker: '–°–º–µ–Ω–∞ –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏ –Ω–∞ —Ä–æ–≤–Ω—É—é' },
    { mod: 'ta', cat: '–ò–≥—Ä—ã', trigger: '–ò–≥—Ä–∞ "–î–∞, –Ω–æ..." (–û–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ)', text: '–ö–∞–∫–æ–π —Ç–≤–æ–π —Å–∫—Ä—ã—Ç—ã–π –≤—ã–∏–≥—Ä—ã—à –≤ —Ç–æ–º, —á—Ç–æ–±—ã –Ω–µ —Ä–µ—à–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?', marker: '–ò–Ω—Å–∞–π—Ç –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏' },

    // --- üï∞ –ü–°–ò–•–û–ê–ù–ê–õ–ò–ó (–§–†–ï–ô–î) ---
    { mod: 'psychoanalysis', cat: '–ü–µ—Ä–µ–Ω–æ—Å', trigger: '–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞', text: '–ù–∞ –∫–æ–≥–æ —è —Å–µ–π—á–∞—Å –ø–æ—Ö–æ–∂, –∫–æ–≥–¥–∞ —Ç—ã –∂–¥–µ—à—å –º–æ–µ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è? –ö–∞–∫–∏–µ —á—É–≤—Å—Ç–≤–∞ —ç—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç?', marker: '–°–≤—è–∑—å —Å –¥–µ—Ç—Å–∫–∏–º –æ–ø—ã—Ç–æ–º' },
    { mod: 'psychoanalysis', cat: '–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏', trigger: '–¢—É–ø–∏–∫ –≤ —Ä–∞—Å—Å–∫–∞–∑–µ', text: '–ù–µ –¥—É–º–∞–π. –ö–∞–∫–∏–µ —Ç—Ä–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–ª–æ–≤–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞ —É–º –≤ —Å–≤—è–∑–∏ —Å —ç—Ç–∏–º –æ–±—Ä–∞–∑–æ–º –∏–∑ —Å–Ω–∞?', marker: '–î–æ—Å—Ç—É–ø –∫ –±–µ—Å—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ–º—É' }
];

/**
 * –ì–ï–ù–ï–†–ê–¶–ò–Ø –≠–ú–ë–ï–î–î–ò–ù–ì–ê (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ª–æ–≥–∏–∫–æ–π –ø–æ–≤—Ç–æ—Ä–æ–≤ –ø—Ä–∏ 429)
 */
async function getEmbedding(text, retries = 5) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    const cacheKey = `vec:${Buffer.from(text).toString('base64').slice(0, 100)}`;
    const cached = vectorCache.get(cacheKey);
    if (cached) {
        logger.info(`‚úÖ –í–µ–∫—Ç–æ—Ä –≤–∑—è—Ç –∏–∑ –∫—ç—à–∞: ${cacheKey}`);
        return cached;
    }

    const maxKeyRetries = googleApiKeys.length;
    
    for (let keyAttempt = 0; keyAttempt < maxKeyRetries; keyAttempt++) {
        const model = genAI.getGenerativeModel({ model: "text-embedding-004" });
        let delay = 10000; // 10 —Å–µ–∫—É–Ω–¥ –±–∞–∑–∞

        for (let i = 0; i < retries; i++) {
            try {
                const result = await model.embedContent(text);
                const vector = result.embedding.values;
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
                vectorCache.set(cacheKey, vector);
                logger.info(`‚úÖ –í–µ–∫—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∫—ç—à: ${cacheKey}`);
                
                return vector;
            } catch (error) {
                if (error.message.includes('429') || error.message.includes('quota') || error.message.includes('limit')) {
                    logger.warn(`‚ö†Ô∏è –õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω. –ü–æ–ø—ã—Ç–∫–∞ ${i + 1}/${retries}. –ñ–¥—É ${delay / 1000} —Å–µ–∫...`);
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                } else {
                    throw error;
                }
            }
        }
        
        // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Å —Ç–µ–∫—É—â–∏–º –∫–ª—é—á–æ–º –∏—Å—á–µ—Ä–ø–∞–Ω—ã, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π
        logger.warn(`üîÑ –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Å –∫–ª—é—á–æ–º #${currentKeyIndex + 1} –∏—Å—á–µ—Ä–ø–∞–Ω—ã. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è...`);
        rotateGoogleKey();
        // –û–±–Ω–æ–≤–ª—è–µ–º genAI —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º
        const newKey = getCurrentGoogleKey();
        const newGenAI = new GoogleGenerativeAI(newKey);
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫—É
    }
    
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–µ–∫—Ç–æ—Ä –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –∏ –∫–ª—é—á–µ–π.");
}

/**
 * –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ –ó–ê–ì–†–£–ó–ö–ò
 */
async function run() {
    console.log(`üöÄ –ó–ê–ü–£–°–ö –ó–ê–ì–†–£–ó–ö–ò: ${KNOWLEDGE_DATA.length} –º–æ–¥—É–ª–µ–π.`);

    for (const [index, item] of KNOWLEDGE_DATA.entries()) {
        try {
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const combinedText = `–°–ò–¢–£–ê–¶–ò–Ø: ${item.trigger} | –ú–ï–¢–û–î: ${item.mod} | –ò–ù–¢–ï–†–í–ï–ù–¶–ò–Ø: ${item.text}`;
           
            const embedding = await getEmbedding(combinedText);

            const { error } = await supabase.from('knowledge_base').insert({
                modality_id: item.mod,
                category: item.cat,
                context_trigger: item.trigger,
                content: item.text,
                embedding: embedding
            });

            if (error) throw error;
           
            console.log(`‚úÖ [${index + 1}/${KNOWLEDGE_DATA.length}] –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${item.mod} -> ${item.cat}`);

            // –ü–∞—É–∑–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ Free Tier
            await new Promise(resolve => setTimeout(resolve, 5000));
        } catch (e) {
            console.error(`‚ùå –°–±–æ–π –Ω–∞ –º–æ–¥—É–ª–µ "${item.trigger}":`, e.message);
        }
    }

    console.log("\nüèÅ –§–ò–ù–ê–õ: –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π Connectum Pro —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞!");
}

run();
